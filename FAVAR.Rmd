---
title     : "Factor Augmented VAR"
subtitle  : "Caso de México"
author    : "Saúl Caballero"
output    : 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: journal
    highlight: tango
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("/home/saul/Repos/FAVAR")
source("./Codigo/source.R")
usePackage("ggthemes")
usePackage("x13binary") 
usePackage("seasonal")  
usePackage("tseries")   
usePackage("dplyr") 
usePackage("forecast")  
usePackage("readr")
usePackage("ggplot2")
usePackage("tibble")
usePackage("vars")
usePackage("tidyr")
##### Estados Unidos: Actividad Real ####
#Real Gross Domestic Product, at 2009 prices
US_GDP <- read_csv("./Datos_Desestacionalizados/GDP IFS (USA).csv")[164:255,2] %>% 
  standar(freq = 4, s=c(1990,4)) 
#Gross National Income
US_GNI <-read_csv("./Datos_Desestacionalizados/GNI IFS (USA).csv")[163:255,2] %>% 
  standar(freq = 4,s=c(1990,3),n=1)
#Personal Consumption Expenditures: Services: Household Consumption Expenditures
US_HCE <- read_csv("./Datos_Desestacionalizados/HCE IFS (USA).csv")[163:255,2] %>% 
  standar(freq = 4, s =c(1990,3),n=1)
#Real Government Consumption Expenditures and Gross Investment
US_GCE <-read_csv("./Datos_Desestacionalizados/GCE IFS (USA).csv")[163:255,2] %>% 
  standar(freq = 4,s=c(1990,3),n=1)
#Exports of Goods and Services
US_EXP <- read_csv("./Datos_Desestacionalizados/EXP IFS (USA).csv")[163:255,2] %>% 
  standar(freq = 4,s=c(1990,3))
#Imports of Goods and Services
US_IMP <- read_csv("./Datos_Desestacionalizados/IMP IFS (USA).csv")[163:255,2] %>% 
  standar(freq = 4,s=c(1990,3))
#Industrial Production: Total Index
US_INDP <- read_csv("./Datos_Desestacionalizados/INDP IFS (USA).csv")[163:255,2] %>% 
  standar(freq = 4,s=c(1990,3))
#Non-durable Manufacturing and Crude Petroleum Products
US_PETRP<- read_csv("./Datos/PETRP IFS (USA).csv")[163:255,2] %>% 
  standar(freq = 4,s=c(1990,3),des=TRUE,n=1)
#Employment Rate: Aged 15-64: All persons for the United States
US_EMP <- read_csv("./Datos_Desestacionalizados/EMP FRED (USA).csv")[55:147,2] %>% 
  standar(freq = 4,s=c(1990,3),n=1)
#rm(US_GDP,US_GNI,US_HCE,US_GCE,US_EXP,US_IMP,US_INDP,US_EMP,US_PETRP)
##### Estados Unidos: Inflacion ####
#Consumer Price Index: Total All Items for the United States
US_CPI <- read_csv("./Datos/CPI IFS (USA).csv")[133:227,2] %>% 
  standar(freq = 4, s=c(1990,1),des=TRUE)
#Gross Domestic Product: Implicit Price deflator
US_GDPDEF <-read_csv("./Datos_Desestacionalizados/GDPDEF IFS (USA).csv")[1:95,2] %>% 
  standar(freq = 4, s=c(1990,1),n=1)
#Producer Price Index for All Commodities
US_PPI <- read_csv("./Datos/PPI IFS (USA).csv")[133:227,2] %>% 
  standar(freq=4,s=c(1990,1),des = TRUE)
#Import Price, All Commodities
US_IMPPRICE <- read_csv("./Datos/IMPPRICE IFS (USA).csv")[133:227,2] %>% 
  standar(freq=4,s=c(1990,1),des = TRUE)
#S&P Index
US_SP <- read_csv("./Datos/SP IFS (USA).csv")[163:255,2] %>% 
  standar(freq=4,s=c(1990,3),des=TRUE,n=1)
#Real Residential Property Prices for United States
US_RHP <- read_csv("./Datos/RHP FRED (USA).csv")[58:152,2] %>% 
  standar(freq=4,s=c(1990,1),des = TRUE, n=1)
#US_WAGES
US_WAGES <- read_csv("./Datos_Desestacionalizados/WRATES FRED (USA).csv")[313:598,2] %>% 
  standar(freq=12,s=c(1990,1),n=1)
#Elimina variables
#rm(US_CPI,US_GDPDEF,US_PPI,US_RHP,US_IMPPRICE,US_SP,US_WAGES)
##### Estados Unidos: Crecimiento del Dinero ####
#Base Money 
US_MB <- read_csv("./Datos_Desestacionalizados/MB IFS (USA).csv")[42:135,2] %>% 
  standar(freq=4,s=c(1990,2),n=2)      
#M1
US_M1 <- read_csv("./Datos_Desestacionalizados/M1 IFS (USA).csv")[126:219,2] %>% 
  standar(freq=4,s=c(1990,2))   
#M2
US_M2 <- read_csv("./Datos_Desestacionalizados/M2 IFS (USA).csv")[126:219,2] %>% 
  standar(freq=4,s=c(1990,2)) 
#M3
US_M3 <- read_csv("./Datos_Desestacionalizados/M3 FRED (USA).csv")[379:657,2] %>% 
  standar(freq=12,s=c(1990,7))  
#Elimina variables
#rm(US_MB,US_M1,US_M2,US_M3)
##### Estados Unidos: Tasa de Interes ####
#Bank Prime Loan Rate
US_BPLRATE <-read_csv("./Datos/BPLRATE FRED (USA).csv")[499:780,2] %>% 
  standar(freq = 12,s=c(1990,7),int =TRUE,des = TRUE)
#Interest Rates, Central Bank Rate
US_CBRATE <- read_csv("./Datos/CBRATE IFS (USA).csv")[32:125,2] %>% 
  standar(freq = 4,s=c(1990,2),int =TRUE,des = TRUE,n=1) 
#Interest Rates, Discount Rate for United States
US_DRATE <- read_csv("./Datos/DRATE FRED (USA).csv")[487:768,2] %>% 
  standar(freq = 12,s=c(1990,7),int =TRUE,des = TRUE)
#Effective Federal Funds Rate
US_FFRATE <- read_csv("./Datos/FFRATE FRED (USA).csv")[433:715,2] %>% 
  standar(freq = 12,s=c(1990,7),int =TRUE,des = TRUE)
# Interest Rates, Government Securities, Treasury Bills for United States
US_TBRATE <- read_csv("./Datos/TBRATE FRED (USA).csv")[487:766,2] %>% 
  standar(freq = 12,s=c(1990,7),int =TRUE,des = TRUE,n=1)
#Elimina variables
#rm(US_BPLRATE,US_DRATE,US_FFRATE,US_TBRATE,US_CBRATE)
##### Mexico: Actividad Real ####
#Gross Domestic Product, Real
MX_GDP <- read_csv("./Datos_Desestacionalizados/GDP IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4, s=c(1990,1),1)
#Indice General de Actividad Economica
MX_IGAE <- read_csv("./Datos/IGAE.csv")[1:249,1] %>% 
  standar(freq = 12,s=c(1993,1),des=TRUE,n=1)
#Household Consumption Expenditure
MX_HCE <- read_csv("./Datos_Desestacionalizados/HCE IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4, s =c(1990,1))
#Real Government Consumption Expenditures and Gross Investment
MX_GCE <- read_csv("./Datos_Desestacionalizados/GCE IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4,s=c(1990,1))
#Exports of Goods and Services
MX_EXP <- read_csv("./Datos_Desestacionalizados/EXP IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4,s=c(1990,1))
#Industrial Production: Total Index
MX_INDP <- read_csv("./Datos/INDP IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4,s=c(1990,1),des = TRUE)
#Manufacturing
MX_MANUFP <- read_csv("./Datos/MANUFP IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4,s=c(1990,1),des = TRUE)
#Non-durable Manufacturing and Crude Petroleum Products
MX_PETRP <- read_csv("./Datos/PETRP IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4,s=c(1990,1),des = TRUE)
#Mining
MX_MINP <- read_csv("./Datos/MINP IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4,s=c(1990,1),des = TRUE)
#Elimina variables
#rm(MX_GDP,MX_IGAE,MX_HCE,MX_GCE,MX_EXP,MX_INDP,MX_MANUFP,MX_MINP,MX_PETRP)
##### Mexico: Inflacion ####
#Consumer Prices, All Items
MX_CPI <- read_csv("./Datos/CPI IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4, s=c(1990,1),des=TRUE,n=1)
#Gross Domestic Product: Implicit Price Deflator
MX_GDPDEF <- read_csv("./Datos_Desestacionalizados/GDPDEF IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4, s=c(1990,1),n=1)
#Producer Price Index for All Commodities
MX_PPI <- read_csv("./Datos/PPI IFS (MEX).csv")[1:95,2] %>% 
  standar(freq=4,s=c(1990,1),des = TRUE,n=1)
#Import Price, All Commodities,
MX_IMPPRICE <- read_csv("./Datos/IMPPRICE IFS (MEX).csv")[1:95,2] %>% 
  standar(freq=4,s=c(1990,1),des = TRUE,n=1)
#Indice de Precios y Cotizaciones
MX_IPC <- read_csv("./Datos/IPC IFS (MEX).csv")[1:285,2] %>% 
  standar(freq=12,s=c(1990,1),des=TRUE,n=1)
#MX_WAGES
MX_WAGES <- read_csv("./Datos/WAGES IFS (MEX).csv")[1:95,2] %>% 
  standar(freq=4,s=c(1990,1),des=TRUE,n=1)
#Elimina variables
#rm(MX_CPI,MX_GDPDEF,MX_PPI,MX_IMPPRICE,MX_IPC,MX_WAGES)
##### Mexico: Crecimiento del Dinero ####
#M1
MX_M1 <- read_csv("./Datos/Money IFS (MEX).csv")[1:95,2] %>% 
  standar(freq=4,s=c(1990,1),des=TRUE,n=1) 
#M2
MX_M2 <- read_csv("./Datos/Money IFS (MEX).csv")[1:95,3] %>% 
  standar(freq=4,s=c(1990,1),des=TRUE,n=1) 
#M3
MX_M3 <- read_csv("./Datos/Money IFS (MEX).csv")[1:95,4] %>% 
  standar(freq=4,s=c(1990,1),des=TRUE,n=1) 
#M4
MX_M4 <- read_csv("./Datos/Money IFS (MEX).csv")[1:95,5] %>% 
  standar(freq=4,s=c(1990,1),des=TRUE,n=1) 
#Elimina variables
#rm(MX_M1,MX_M2,MX_M3,MX_M4)
##### Mexico: Tasa de Interes ####
#Interest Rates, Lending Rate
MX_LRATE <- read_csv("./Datos/LRATE IFS (MEX).csv")[1:80,2] %>% 
  standar(freq = 4,s=c(1993,4),int =TRUE,des = TRUE,n=1) 
#Interest Rates, Money Market Rate
MX_MMRATE <- read_csv("./Datos/MMRATE IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4,s=c(1990,1),int =TRUE,des = TRUE)
#Interest Rates, Deposit Rate
MX_DRATE <- read_csv("./Datos/DRATE IFS (MEX).csv")[1:95,2]   %>% 
  standar(freq = 4,s=c(1990,1),int =TRUE,des = TRUE)
#Interest Rates, Government Securities, Treasury Bills
MX_TBRATE <- read_csv("./Datos/TBRATE IFS (MEX).csv")[1:95,2] %>% 
  standar(freq = 4,s=c(1990,1),int =TRUE,des = TRUE) 
#Elimina variables
#rm(MX_LRATE,MX_MMRATE,MX_DRATE,MX_TBRATE)
##### Tipo de Cambio ####
MXN_USD <- read_csv("./Datos/MXN_USD1.csv")[1:288,2] %>% 
  standar(freq=12,s=c(1990,1),des=TRUE)   
#autoplot(MXN_USD)+                                                                  
#  geom_line(color = 'blue')+                                        
#  labs(title="Tipo de Cambio",x="",y="",subtitle="Pesos por Dólar")+
#  theme_economist() 
##### Componentes Principales ####
info <- cbind(MX_CPI,MX_DRATE,MX_EXP,MX_GCE,MX_GDP,MX_GDPDEF,MX_HCE,MX_IMPPRICE,MX_INDP,MX_IPC,MX_M1,MX_M2,MX_M3,MX_M4,MX_MANUFP,MX_MINP,MX_MMRATE,MXN_USD,MX_PETRP,MX_PPI,MX_WAGES,US_BPLRATE,US_CPI,US_DRATE,US_EMP,US_EXP,US_FFRATE,US_GCE,US_GDP,US_GDPDEF,US_GNI,US_HCE,US_IMP,US_IMPPRICE,US_INDP,US_M1,US_M2,US_M3,US_MB,US_PETRP,US_PPI,US_RHP,US_SP,US_TBRATE,US_WAGES) %>% as_tibble
```
***
#Introducción
***
¿Por qué usar un VAR con factores?

* Una de las principales desventajas de los VAR's es que solo pueden usar un pequeño número de variables, el cual es 
improbable que utilice toda la información que usan los bancos centrales. Esto se puede ocasionar:
    + Los bancos centrales tienen información no reflejada en el análisis de un VAR, por lo tanto la medida de la política monetaria puede estar contaminada, por ejemplo:
        + **Rompecabezas de los precios**: El resultado convencional de un VAR es que **ante una política monetaria restrictiva, la inflación aumenta un poco** , esto va en contra de la teoría economíca clásica prediciría. Un ejemplo de mecanismo que podría estar ocurriendo es que si el banco central restringe su política ante la anticipación de inflación futura y estás señales no las puede tomar en cuenta el modelo, entonces para lo que el VAR parece ser un choque en la política monetaria puede ser realmente una respuesta del banco central a nueva información de la inflación. 
  + Se pueden hacer funciones impulso-respuesta para todas las variables que uno considere importantes.

***

#Procesamiento de los datos
***

Antes de cualquier transformación, las variables fueron desestacionalizadas con los asientos *X-13 Arima*.

## Tasas de interés

Las tasas de interés se modifican de la siguiente forma:

1. Se calcula $i^*$ de la siguiene forma: $i^*=\frac{1}{4} ln(1+\frac{i}{100})$.
2. Se calcula la primera diferencia.
3. Se estandariza la variable: $i^{estandar}= \frac{i^*-\bar{i^*}}{\sigma_{i^*}}$.

## Otras variables

Las demás variables se modifican de la siguiente forma:

1. Se calcula el logarítmo de la variable.
2. Se calcula la primera diferencia 
3. Se estandariza la variable: $x^{estandar}= \frac{x^*-\bar{x^*}}{\sigma_{x^*}}$.

***

#FAVAR 
***

Primero definimos las variables:

* Se define las variables observables $Y_t$, en este caso la tasa de interés de México y Estados Unidos.

* Se definen las variables que queremos considerar en el modelo $X_t$. Posteriormente, se obtienen los componentes principales de estas variables  y se les denomina $F_t$.

El **FAVAR** se define de la siguiente forma:

$$\begin{bmatrix}
F_t\\
Y_t
\end{bmatrix}=
\Phi(L) \begin{bmatrix}
F_{t-1}\\
Y_{t-1}
\end{bmatrix}+v_t$$

donde $\Phi(L)$ son los lags del polinomio de orden finito de orden $d$. El término del error $v_t$ tiene media cero y matriz de covarianza $Q$.

***

#Modelo elegido 
***

##FAVAR con 9 factores {.tabset .tabset-fade}
```{r,echo=FALSE}
nfac <- 9
comp <- info %>% prcomp(scale=T) %>% predict %>% .[,1:nfac] %>% as_tibble
pca <- info %>% prcomp(scale=T) 
y <- comp %>% 
  mutate(Int_US=US_CBRATE,
         Int_MX=MX_TBRATE)
```
```{r,echo=FALSE}
model <- VAR(y)

impulse  <- c("Int_US","Int_MX")

df <- get_irf(model,impulse,pca) 
```
###Tasa de interés de Estados Unidos.
```{r,echo=FALSE}
ggplot(data=df %>% 
         filter(shock==impulse[1]) %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )),
       aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  geom_line(aes(y=upper),colour="red",linetype = "dashed")+
  geom_line(aes(y=lower),colour="red",linetype = "dashed")+
  geom_ribbon(aes(x=cons,ymin=lower,ymax=upper),alpha=.25,show.legend=FALSE)+
  labs(title="Choque a la Tasa de Interés de E.U.A.",x="",y="",subtitle="Funciones Impulso-Respuesta")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 
```
***

###Tasa de interés de México.
```{r,echo=FALSE}
ggplot(data=df %>% 
         filter(shock==impulse[2]) %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )),
       aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  geom_line(aes(y=upper),colour="red",linetype = "dashed")+
  geom_line(aes(y=lower),colour="red",linetype = "dashed")+
  geom_ribbon(aes(x=cons,ymin=lower,ymax=upper),alpha=.25,show.legend=FALSE)+
  labs(title="Choque a la Tasa de Interés de México",x="",y="",subtitle="Funciones Impulso-Respuesta")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 
```
***

###Predicciones
```{r, echo=FALSE}
pred <- get_pred(model,pca) 

ggplot(data= pred %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )) ,aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  labs(title="Prediccion",x="",y="")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 

```

***

#Otros modelos {.tabset .tabset-fade}
```{r,echo=FALSE}
nfac <- 10
comp <- info %>% prcomp(scale=T) %>% predict %>% .[,1:nfac] %>% as_tibble
pca <- info %>% prcomp(scale=T) 
y <- comp %>% 
  mutate(Int_US=US_CBRATE,
         Int_MX=MX_TBRATE)
```
## FAVAR(1) con 10 factores {.tabset .tabset-fade}
```{r,echo=FALSE}
model <- VAR(y)

impulse  <- c("Int_US","Int_MX")

df <- get_irf(model,impulse,pca) 
```
###Tasa de interés de Estados Unidos.
```{r,echo=FALSE}
ggplot(data=df %>% 
         filter(shock==impulse[1]) %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )),
       aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  geom_line(aes(y=upper),colour="red",linetype = "dashed")+
  geom_line(aes(y=lower),colour="red",linetype = "dashed")+
  geom_ribbon(aes(x=cons,ymin=lower,ymax=upper),alpha=.25,show.legend=FALSE)+
  labs(title="Choque a la Tasa de Interés de E.U.A.",x="",y="",subtitle="Funciones Impulso-Respuesta")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 
```

###Tasa de interés de México.
```{r,echo=FALSE}
ggplot(data=df %>% 
         filter(shock==impulse[2]) %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )),
       aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  geom_line(aes(y=upper),colour="red",linetype = "dashed")+
  geom_line(aes(y=lower),colour="red",linetype = "dashed")+
  geom_ribbon(aes(x=cons,ymin=lower,ymax=upper),alpha=.25,show.legend=FALSE)+
  labs(title="Choque a la Tasa de Interés de México",x="",y="",subtitle="Funciones Impulso-Respuesta")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 
```

###Predicciones
```{r, echo=FALSE}
pred <- get_pred(model,pca) 

ggplot(data= pred %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )) ,aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  labs(title="Prediccion",x="",y="")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 

```


## FAVAR(2) con 10 factores {.tabset .tabset-fade}

```{r,echo=FALSE}
model <- VAR(y,p=2)

impulse  <- c("Int_US","Int_MX")

df <- get_irf(model,impulse,pca) 
```
###Tasa de interés de Estados Unidos.
```{r,echo=FALSE}
ggplot(data=df %>% 
         filter(shock==impulse[1]) %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )),
       aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  geom_line(aes(y=upper),colour="red",linetype = "dashed")+
  geom_line(aes(y=lower),colour="red",linetype = "dashed")+
  geom_ribbon(aes(x=cons,ymin=lower,ymax=upper),alpha=.25,show.legend=FALSE)+
  labs(title="Choque a la Tasa de Interés de E.U.A.",x="",y="",subtitle="Funciones Impulso-Respuesta")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 
```

###Tasa de interés de México.
```{r,echo=FALSE}
ggplot(data=df %>% 
         filter(shock==impulse[2]) %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )),
       aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  geom_line(aes(y=upper),colour="red",linetype = "dashed")+
  geom_line(aes(y=lower),colour="red",linetype = "dashed")+
  geom_ribbon(aes(x=cons,ymin=lower,ymax=upper),alpha=.25,show.legend=FALSE)+
  labs(title="Choque a la Tasa de Interés de México",x="",y="",subtitle="Funciones Impulso-Respuesta")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 
```

###Predicciones
```{r, echo=FALSE}
pred <- get_pred(model,pca) 

ggplot(data= pred %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )) ,aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  labs(title="Prediccion",x="",y="")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 

```
```{r,echo=FALSE}
nfac <- 9
comp <- info %>% prcomp(scale=T) %>% predict %>% .[,1:nfac] %>% as_tibble
pca <- info %>% prcomp(scale=T) 
y <- comp %>% 
  mutate(Int_US=US_CBRATE,
         Int_MX=MX_TBRATE)
```

## FAVAR(2) con 9 factores {.tabset .tabset-fade}

```{r,echo=FALSE}
nfac <- 9
comp <- info %>% prcomp(scale=T) %>% predict %>% .[,1:nfac] %>% as_tibble
pca <- info %>% prcomp(scale=T) 
y <- comp %>% 
  mutate(Int_US=US_CBRATE,
         Int_MX=MX_TBRATE)
```

```{r,echo=FALSE}
model <- VAR(y,p=2)

impulse  <- c("Int_US","Int_MX")

df <- get_irf(model,impulse,pca) 
```
###Tasa de interés de Estados Unidos.
```{r,echo=FALSE}
ggplot(data=df %>% 
         filter(shock==impulse[1]) %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )),
       aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  geom_line(aes(y=upper),colour="red",linetype = "dashed")+
  geom_line(aes(y=lower),colour="red",linetype = "dashed")+
  geom_ribbon(aes(x=cons,ymin=lower,ymax=upper),alpha=.25,show.legend=FALSE)+
  labs(title="Choque a la Tasa de Interés de E.U.A.",x="",y="",subtitle="Funciones Impulso-Respuesta")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 
```

###Tasa de interés de México.
```{r,echo=FALSE}
ggplot(data=df %>% 
         filter(shock==impulse[2]) %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )),
       aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  geom_line(aes(y=upper),colour="red",linetype = "dashed")+
  geom_line(aes(y=lower),colour="red",linetype = "dashed")+
  geom_ribbon(aes(x=cons,ymin=lower,ymax=upper),alpha=.25,show.legend=FALSE)+
  labs(title="Choque a la Tasa de Interés de México",x="",y="",subtitle="Funciones Impulso-Respuesta")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 
```

###Predicciones
```{r, echo=FALSE}
pred <- get_pred(model,pca) 

ggplot(data= pred %>% 
         filter(var %in% c("MXN_USD","MX_GDP","MX_CPI","Int_MX")) %>% 
         mutate(vars= case_when(
           .$var == "MXN_USD" ~ "Tipo de Cambio",
           .$var == "MX_GDP"  ~ "PIB",
           .$var == "MX_CPI"  ~ "Inflación",
           .$var == "Int_MX"  ~ "Tasa de Interés"
         )) ,aes(y=pred,x=cons))+
  geom_line(colour="blue")+
  labs(title="Prediccion",x="",y="")+
  facet_wrap(~vars,ncol=2)+
  theme_economist() 

```
